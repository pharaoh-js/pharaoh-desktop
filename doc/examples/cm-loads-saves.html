<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>codemirror thing</title>
  <!-- this version can load a file from fs, and save same file back as new file,
       but doesn't load into codemirror...?
  -->
  <script src='http://codemirror.net/lib/codemirror.js'></script>
  <script src='http://codemirror.net/mode/xml/xml.js'></script>
  <script src='http://codemirror.net/mode/javascript/javascript.js'></script>
  <script src='http://codemirror.net/mode/css/css.js'></script>
  <script src='http://codemirror.net/mode/htmlmixed/htmlmixed.js'></script>
  <link rel='stylesheet' href='http://codemirror.net/lib/codemirror.css'>
  <link rel='stylesheet' href='http://codemirror.net/doc/docs.css'>
  <style type='text/css'>
    .CodeMirror{float: left;width: 50%;border: 1px solid black;}
    iframe{width: 49%;float: left;height: 300px;border: 1px solid black;border-left: 0px;}
  </style>
  <script type="text/javascript">
    var delay
    var editor = CodeMirror.fromTextArea(document.getElementById('code'), {
        mode: 'text/html'
      , tabMode: 'indent'
      , lineNumbers: true
      , lineWrapping: true
      , autoCloseTags: true
    })
    editor.on("change", function(){
      clearTimeout(delay)
      delay = setTimeout(updatePreview, 300)
    })
    function updatePreview(){
      var previewFrame = document.getElementById('preview')
      var preview =  previewFrame.contentDocument ||  previewFrame.contentWindow.document
      preview.open()
      preview.write(editor.getValue())
      preview.close()
    }
    setTimeout(updatePreview, 300)
    function saveTextAsFile(){
      var textToWrite = document.getElementById("code").value
        , textFileAsBlob = new Blob([textToWrite], {type:'text/plain'})
        , fileNameToSaveAs = "bar.html"
        , downloadLink = document.createElement("a")
      downloadLink.download = fileNameToSaveAs
      downloadLink.innerHTML = "Download File"
      if(window.webkitURL != null){ // chromium lets click clink w/o adding to DOM
        downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob)
      } else { // mozilla does not
        downloadLink.href = window.URL.createObjectURL(textFileAsBlob)
        downloadLink.onclick = destroyClickedElement
        downloadLink.style.display = "none"
        document.body.appendChild(downloadLink)
      }
      downloadLink.click()
    }
    function destroyClickedElement(event){document.body.removeChild(event.target)}
    function loadfile(input){
      var reader = new FileReader()
      reader.onload = function(e){document.getElementById('code').value = e.target.result}
      reader.readAsText(input.files[0]);
    }
    var input = document.getElementById("select")
    function selectTheme(){
      var theme = input.options[input.selectedIndex].innerHTML
      editor.setOption("theme", theme)
    }
    var choice = document.location.search && decodeURIComponent(document.location.search.slice(1))
    if(choice){
      input.value = choice
      editor.setOption("theme", choice)
    }
  </script>
</head>
<body>
  <textarea id="code" name="code">
    <style>*{background:#101010;color:#ccc;font-family:monospace;}</style>
    <h2>howdy</h2>
  </textarea>
  <iframe id="preview"></iframe>
  <input type="file" onchange="loadfile(this)">
  <a href="#my-header" onclick='saveTextAsFile()'>download</a>
</body>
</html>